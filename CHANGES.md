# Changes - Database Setup and From-Scratch Deployment

This document tracks the changes made to enable complete from-scratch deployment of LiteLLM with PostgreSQL.

## Security: Store LiteLLM Master Key in Vault (Latest)

### Summary

Moved LiteLLM master key from hardcoded Helm values to secure Vault storage with Vault Agent injection. This completes the security posture where all secrets (OpenRouter API key, database password, and LiteLLM master key) are stored in Vault.

### Rationale

Previously, the master key was hardcoded as `"poc-master-key"` in:
- `litellm/litellm-values.yaml` (line 21 in the Vault template)
- `litellm/config.yaml` (reference file)
- All test examples in README.md

This violated the principle of "least hardcoded secrets" and was flagged as a production consideration in the README.

### Changes

**Modified Files:**
1. **scripts/generate-env.sh**
   - Now generates both `POSTGRES_PASSWORD` and `LITELLM_MASTER_KEY` (40 characters each)
   - Uses the same secure random generation approach (openssl or /dev/urandom)
   - Updated usage documentation and success messages

2. **.env.example**
   - Added `LITELLM_MASTER_KEY` template entry
   - Documented that it's auto-generated by the script

3. **vault/init-vault-secrets.sh**
   - Reads `LITELLM_MASTER_KEY` from environment or `.env` file
   - Validates key length (warns if < 12 characters)
   - Stores master key in Vault at `secret/litellm/masterkey` with field `master-key`
   - Updated usage documentation to reflect three secrets
   - Updated success message to list all three stored secrets

4. **vault/vault-policy.hcl**
   - ✅ No changes needed (wildcard path `secret/data/litellm/*` already covers new path)

5. **litellm/litellm-values.yaml**
   - Removed hardcoded `master_key: "poc-master-key"`
   - Updated Vault Agent template to fetch master key from `secret/data/litellm/masterkey`
   - Template now uses both `$apiKey` and `$masterKey` variables from separate Vault secrets

6. **litellm/config.yaml**
   - Replaced hardcoded master key with placeholder: `REPLACED_AT_RUNTIME_BY_VAULT_TEMPLATE`
   - Added comments explaining Vault Agent injection

7. **README.md**
   - Updated TL;DR Quick Deploy to mention three secrets
   - Updated "Initialize Vault" section to list all three secret paths with fields
   - Changed all test examples to use `source .env` and `$LITELLM_MASTER_KEY`
   - Removed "Store master key in Vault" from production considerations (now implemented)
   - Enhanced Secret Management section to list all three secrets
   - Added `vault kv get secret/litellm/masterkey` to troubleshooting examples

8. **DATABASE.md**
   - Updated Quick Start to mention both credentials generated
   - Documented master key storage in Vault alongside database password

### Migration Guide

**For New Deployments:**
Follow the updated README workflow—the master key will be auto-generated and stored in Vault automatically.

**For Existing Deployments:**

If you want to preserve your current master key (to avoid invalidating existing API clients):

```bash
# 1. Export current master key (if you know it)
export LITELLM_MASTER_KEY="poc-master-key"  # or your custom key

# 2. Store it in Vault
./vault/init-vault-secrets.sh

# 3. Upgrade Helm deployment
helm upgrade litellm ./charts/litellm-helm -n litellm -f litellm/litellm-values.yaml

# 4. Verify pods restart and master key works
source .env
kubectl -n litellm port-forward svc/litellm 4000:4000 &
curl -sS -H "Authorization: Bearer $LITELLM_MASTER_KEY" http://127.0.0.1:4000/models
```

If you want to rotate to a new secure key:

```bash
# 1. Generate new credentials
./scripts/generate-env.sh

# 2. Store in Vault
export OPENROUTER_API_KEY="your-key"
./vault/init-vault-secrets.sh

# 3. Upgrade deployment
helm upgrade litellm ./charts/litellm-helm -n litellm -f litellm/litellm-values.yaml

# 4. Update your API clients with the new master key from .env
```

### Testing Checklist

- [x] Generate `.env` with `./scripts/generate-env.sh`
- [x] Verify `.env` contains both `POSTGRES_PASSWORD` and `LITELLM_MASTER_KEY` (40 chars each)
- [x] Initialize Vault with `./vault/init-vault-secrets.sh`
- [x] Verify three secrets exist in Vault:
  - `vault kv get secret/litellm/openrouter` → has field `api-key`
  - `vault kv get secret/litellm/database` → has field `password`
  - `vault kv get secret/litellm/masterkey` → has field `master-key`
- [x] Deploy/upgrade LiteLLM Helm chart
- [x] Verify pod starts without errors
- [x] Verify Vault Agent injected config contains the master key (not the placeholder)
- [x] Test API with master key: `curl -H "Authorization: Bearer $LITELLM_MASTER_KEY" http://localhost:4000/models`

### Security Benefits

1. **No Hardcoded Secrets**: All secrets are now dynamically injected at runtime
2. **Secure Generation**: Master keys use cryptographically secure random generation (40 characters)
3. **Centralized Management**: All secrets managed through Vault (single source of truth)
4. **Easy Rotation**: Update `.env`, re-run `init-vault-secrets.sh`, restart pods
5. **Audit Trail**: Vault provides audit logs for secret access (when enabled in production)

---

## Summary

Added missing scripts and documentation to enable users to deploy LiteLLM from scratch without manual secret management.

## New Files Added

### 1. `.env.example`
- Template file showing required environment variables
- Documents that `POSTGRES_PASSWORD` should be generated using `scripts/generate-env.sh`
- Provides guidance to users on secure credential management

### 2. `scripts/generate-env.sh`
- Bash script to generate secure `.env` file with a 40-character random password
- Uses `openssl` (preferred) or falls back to `/dev/urandom`
- Prompts before overwriting existing `.env` file
- Sets file permissions to 600 (owner read/write only)
- Validates password generation

## Modified Files

### 1. `vault/init-vault-secrets.sh`
**Changes:**
- Added database password detection with precedence:
  1. `DB_PASSWORD` environment variable
  2. `POSTGRES_PASSWORD` environment variable  
  3. `.env` file (sourced automatically)
- Now stores **both** secrets in Vault:
  - `secret/litellm/openrouter` (existing - OpenRouter API key)
  - `secret/litellm/database` (new - PostgreSQL password)
- Added password length validation (warns if < 12 characters)
- Updated usage documentation with multiple examples
- Enhanced success message to list all stored secrets

### 2. `README.md`
**Changes:**
- Updated Prerequisites section:
  - Added Docker and Docker Compose
  - Added openssl to required tools
  - Made jq explicitly optional
- Updated TL;DR - Quick Deploy:
  - Added Step 0: Generate .env and start database
  - Updated Step 4 description to clarify both secrets are stored
- Updated Quick start section:
  - Added new Step 1: Setup local database
  - Included note about external PostgreSQL instances
  - Renumbered all subsequent steps (2-8)
  - Added database password to Vault initialization explanation
- Updated Project structure to include:
  - `DATABASE.md`
  - `.env.example`
  - `docker-compose.yml`
  - `scripts/generate-env.sh`

### 3. `DATABASE.md`
**Changes:**
- Added Step 0 to Quick Start: Generate secure credentials
- Explained how `.env` is used by both Docker Compose and Vault
- Added link to main README for complete workflow
- Clarified where database password is stored in Vault (`secret/litellm/database` with field `password`)

## Existing Files (No Changes Required)

### `docker-compose.yml`
- Already correctly configured to read `POSTGRES_PASSWORD` from `.env`
- No modifications needed

### `.gitignore`
- Already contains `.env` entry
- No modifications needed

### `litellm/litellm-values.yaml`
- Already references correct Vault path: `secret/data/litellm/database`
- No modifications needed

## Workflow Impact

### Before (Incomplete)
Users had to manually:
1. Create `.env` file with password
2. Remember to store database password in Vault
3. Figure out the correct Vault path and field name
4. Start docker-compose at some point (undocumented in main flow)

❌ **Result:** LiteLLM pods would fail because `secret/litellm/database` didn't exist in Vault

### After (Complete)
Users follow a clear step-by-step process:
1. Run `./scripts/generate-env.sh` → secure password created automatically
2. Run `docker compose up -d` → database starts with generated password
3. Run `./vault/init-vault-secrets.sh` → **both** OpenRouter key and DB password stored in Vault
4. Deploy LiteLLM → pod starts successfully with all required secrets

✅ **Result:** Complete from-scratch deployment works without manual intervention

## Security Improvements

1. **Password Generation:** Uses cryptographically secure random generation
2. **File Permissions:** `.env` file automatically set to 600 (owner only)
3. **No Password Echo:** Scripts never print passwords to terminal
4. **Validation:** Warns if password is too short
5. **Git Safety:** `.env.example` provided but real `.env` is gitignored

## Testing Checklist

To validate this implementation, a new user should be able to:

- [ ] Clone the repository
- [ ] Run `./scripts/generate-env.sh` successfully
- [ ] Start PostgreSQL with `docker compose up -d`
- [ ] Create namespace: `kubectl create namespace litellm`
- [ ] Install Vault: `helm install vault ./charts/vault -n litellm -f vault/vault-values.yaml`
- [ ] Initialize Vault: `OPENROUTER_API_KEY=<key> ./vault/init-vault-secrets.sh`
- [ ] Verify both secrets exist in Vault:
  - `vault kv get secret/litellm/openrouter` (has `api-key`)
  - `vault kv get secret/litellm/database` (has `password`)
- [ ] Deploy LiteLLM: `helm install litellm ./charts/litellm-helm -n litellm -f litellm/litellm-values.yaml`
- [ ] Verify LiteLLM pod starts without errors
- [ ] Test LiteLLM endpoint with a sample request

## Commit Messages

```
feat(env): add .env.example and secure generator script

- Add .env.example template with documentation
- Add scripts/generate-env.sh for secure password generation
- Script uses openssl or /dev/urandom fallback
- Generates 40-character alphanumeric passwords
- Sets proper file permissions (600)

feat(vault): store database password in Vault

- Update vault/init-vault-secrets.sh to store DB password
- Support multiple input sources: DB_PASSWORD, POSTGRES_PASSWORD, .env
- Store at secret/litellm/database with field 'password'
- Add password length validation
- Maintain backward compatibility with OpenRouter secret

docs: add database setup steps to deployment workflow

- Update README.md TL;DR and Quick start sections
- Add database setup as Step 0/1 in workflows
- Update prerequisites to include Docker/Docker Compose
- Clarify that both secrets are stored in Vault
- Update DATABASE.md with .env generation instructions
- Update project structure to show new files
```
