# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Quick Commands

### Environment Setup
```bash
# Generate secure credentials (.env file)
./scripts/generate-env.sh

# Start local PostgreSQL database  
docker compose up -d
```

### Kubernetes Deployment
```bash
# Create namespace
kubectl create namespace litellm

# Install Vault with Agent Injector
helm install vault ./charts/vault -n litellm -f vault/vault-values.yaml
kubectl -n litellm wait --for=condition=ready pod -l app.kubernetes.io/name=vault --timeout=300s

# Initialize Vault with secrets (requires OPENROUTER_API_KEY)
export OPENROUTER_API_KEY="sk-or-v1-..."
./vault/init-vault-secrets.sh

# Deploy LiteLLM
helm install litellm ./charts/litellm-helm -n litellm -f litellm/litellm-values.yaml
kubectl -n litellm rollout status deploy/litellm --timeout=300s
```

### Testing and Validation
```bash
# Port-forward LiteLLM service
kubectl -n litellm port-forward svc/litellm 4000:4000 &

# Test with API call
source .env
curl http://127.0.0.1:4000/chat/completions \
  -H "Authorization: Bearer $LITELLM_MASTER_KEY" \
  -H "Content-Type: application/json" \
  -d '{"model":"openai-gpt-4","messages":[{"role":"user","content":"Hello!"}]}'

# Verify Vault injection worked
kubectl -n litellm exec deploy/litellm -c litellm -- cat /vault/secrets/config.yaml
```

### Cleanup
```bash
./scripts/cleanup.sh
```

## Architecture Overview

### Components
- **LiteLLM Proxy**: OpenAI-compatible API proxy that routes to OpenRouter models (GPT-4, Claude-3-Opus)
- **HashiCorp Vault**: Secret management with Agent Injector for runtime secret injection
- **PostgreSQL**: Local database (simulates AWS RDS) for LiteLLM request logging and model data
- **Vault Agent**: Sidecar container that renders config files from Vault templates

### Data Flow
1. API requests → LiteLLM Proxy (port 4000)
2. LiteLLM → OpenRouter API (using injected API key)
3. Request/response data → PostgreSQL (using injected connection string)
4. Configuration rendered by Vault Agent from templates in Helm values

### Kubernetes Topology
- **Deployment**: `litellm` with vault-agent sidecar and litellm containers
- **Service**: ClusterIP on port 4000
- **ServiceAccount**: `litellm` (bound to Vault role)
- **Secret Management**: No Kubernetes Secrets - all via Vault KV v2

### Secret Management Architecture
- `secret/litellm/secretapps`: OpenRouter API key and LiteLLM master key
- `secret/litellm/database`: PostgreSQL password
- Vault Agent renders config.yaml and db_env.sh at pod startup
- No ConfigMap volumes - configuration is inline in Helm values as Vault templates

## Configuration and Environment

### Environment Variables (from .env)
- `POSTGRES_PASSWORD`: 40-char database password (generated by scripts/generate-env.sh)
- `LITELLM_MASTER_KEY`: 40-char API authentication key (generated by scripts/generate-env.sh)
- `OPENROUTER_API_KEY`: External API key (must be provided manually)

### Key Configuration Files
- `litellm/litellm-values.yaml`: Helm values with Vault Agent annotations and config templates
- `vault/vault-values.yaml`: Vault dev mode configuration with Agent Injector enabled
- `vault/vault-policy.hcl`: Policy granting read access to `secret/data/litellm/*`
- `docker-compose.yml`: Local PostgreSQL setup matching production schema

## Database Workflow

### Local Database (PostgreSQL 16)
```bash
# Start database (reads POSTGRES_PASSWORD from .env)
docker compose up -d

# Check database health
docker compose ps

# Connect to database  
source .env
psql "postgresql://llmproxy:${POSTGRES_PASSWORD}@localhost:5432/litellm"

# Check tables created by LiteLLM
psql "postgresql://llmproxy:${POSTGRES_PASSWORD}@localhost:5432/litellm" \
  -c "SELECT table_name FROM information_schema.tables WHERE table_schema='public';"
```

### Database Connection
- **Local**: `postgresql://llmproxy:${POSTGRES_PASSWORD}@localhost:5432/litellm`
- **Kubernetes**: `postgresql://llmproxy:${PASSWORD}@host.docker.internal:5432/litellm`
- LiteLLM automatically creates required tables on startup
- No manual migrations needed

## Kubernetes Workflow Details

### Vault Operations
```bash
# Port-forward Vault UI/API
kubectl -n litellm port-forward svc/vault 8200:8200

# Access Vault (dev token: root)  
export VAULT_ADDR=http://127.0.0.1:8200
export VAULT_TOKEN=root

# Verify secrets
vault kv get secret/litellm/secretapps
vault kv get secret/litellm/database

# Check Kubernetes auth
vault read auth/kubernetes/role/litellm-role
```

### Helm Operations
```bash
# Lint charts
helm lint ./charts/vault -f vault/vault-values.yaml
helm lint ./charts/litellm-helm -f litellm/litellm-values.yaml

# Template rendering (dry-run)
helm template vault ./charts/vault -n litellm -f vault/vault-values.yaml
helm template litellm ./charts/litellm-helm -n litellm -f litellm/litellm-values.yaml

# Upgrade deployments
helm upgrade vault ./charts/vault -n litellm -f vault/vault-values.yaml
helm upgrade litellm ./charts/litellm-helm -n litellm -f litellm/litellm-values.yaml
```

### Troubleshooting
```bash
# Check Vault Agent injection
kubectl -n litellm describe pod -l app.kubernetes.io/name=litellm

# View logs
kubectl -n litellm logs deploy/litellm -c vault-agent
kubectl -n litellm logs deploy/litellm -c litellm

# Verify pod has both containers
kubectl -n litellm get pods -o jsonpath='{.items[0].spec.containers[*].name}'
# Should show: vault-agent litellm
```

## Important Documentation

### Essential Reading
- **README.md**: Complete deployment walkthrough with TL;DR quickstart
- **DATABASE.md**: PostgreSQL setup, connection strings, and management commands  
- **CHANGES.md**: Recent security improvements moving master key to Vault

### Key Sections
- README "TL;DR - Quick Deploy": 7-step deployment process
- README "Design notes": Explains no-ConfigMap architecture and Vault template approach
- DATABASE "Quick Start": Local database bootstrap process
- CHANGES "Security: Store LiteLLM Master Key in Vault": Latest security enhancements

## Prerequisites

- Local Kubernetes cluster (OrbStack, Kind, Minikube, Docker Desktop, k3d)
- Docker and Docker Compose 
- kubectl, Helm 3.8+, vault CLI, openssl
- OpenRouter API key (`sk-or-v1-...`)

## Adding Models

Edit `litellm/litellm-values.yaml` in the Vault template section and add to `model_list`. Example:
```yaml
- model_name: gemini-pro
  litellm_params:
    model: openrouter/google/gemini-pro
    api_base: https://openrouter.ai/api/v1
    api_key: "{{ index .Data.data \"openrouter_api_key\" }}"
```

Then upgrade: `helm upgrade litellm ./charts/litellm-helm -n litellm -f litellm/litellm-values.yaml`